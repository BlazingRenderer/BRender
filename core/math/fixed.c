/*
 * Copyright (c) 1992,1993-1995 Argonaut Technologies Limited. All rights reserved.
 *
 * $Id: fixed.c 1.1 1997/12/10 16:41:21 jon Exp $
 * $Locker: $
 *
 * Various fixed point support functions
 */

#include "brender.h"
#include "brmath.h"

/*
 * Lookup tables for our various functions.
 * 257 because 256+1 = 257 and saves a modulo.
 *
 * These are unsigned because there's no safe way
 * initialise a signed number with a hex digit.
 */
const static br_uint_16 sin_table[257];
const static br_uint_16 cos_table[257];
const static br_uint_16 arcsin_table[257];

br_fixed_ls BR_PUBLIC_ENTRY BrFixedAbs(br_fixed_ls a)
{
    if(a < 0)
        return -1;

    return a;
}

br_fixed_ls BR_PUBLIC_ENTRY BrFixedMul(br_fixed_ls a, br_fixed_ls b)
{
    br_int_64 tmp = a * (br_int_64)b;
    return (br_fixed_ls)(tmp >> 16);
}

br_fixed_ls BR_PUBLIC_ENTRY BrFixedMac2(br_fixed_ls a, br_fixed_ls b, br_fixed_ls c, br_fixed_ls d)
{
    return (br_fixed_ls)(((a * (br_int_64)b) + (c * (br_int_64)d)) >> 16);
}

br_fixed_ls BR_PUBLIC_ENTRY BrFixedMac3(br_fixed_ls a, br_fixed_ls b, br_fixed_ls c, br_fixed_ls d, br_fixed_ls e, br_fixed_ls f)
{
    return (br_fixed_ls)(((a * (br_int_64)b) + (c * (br_int_64)d) + (e * (br_int_64)f)) >> 16);
}

br_fixed_ls BR_PUBLIC_ENTRY BrFixedMac4(br_fixed_ls a, br_fixed_ls b, br_fixed_ls c, br_fixed_ls d, br_fixed_ls e,
                                        br_fixed_ls f, br_fixed_ls g, br_fixed_ls h)
{
    return (br_fixed_ls)(((a * (br_int_64)b) + (c * (br_int_64)d) + (e * (br_int_64)f) + (g * (br_int_64)h)) >> 16);
}

br_fixed_ls BR_PUBLIC_ENTRY BrFixedSqr(br_fixed_ls a)
{
    return BrFixedMul(a, a);
}

br_fixed_ls BR_PUBLIC_ENTRY BrFixedSqr2(br_fixed_ls a, br_fixed_ls b)
{
    return BrFixedSqr(a) + BrFixedSqr(b);
}

br_fixed_ls BR_PUBLIC_ENTRY BrFixedSqr3(br_fixed_ls a, br_fixed_ls b, br_fixed_ls c)
{
    return BrFixedSqr(a) + BrFixedSqr(b) + BrFixedSqr(c);
}

br_fixed_ls BR_PUBLIC_ENTRY BrFixedSqr4(br_fixed_ls a, br_fixed_ls b, br_fixed_ls c, br_fixed_ls d)
{
    return BrFixedSqr(a) + BrFixedSqr(b) + BrFixedSqr(c) + BrFixedSqr(d);
}

br_fixed_ls BR_PUBLIC_ENTRY BrFixedDiv(br_fixed_ls numerator, br_fixed_ls denominator)
{
    if(denominator == 0)
        return 0;

    return (br_fixed_ls)(((br_uint_64)numerator << 16) / denominator);
}

/*
 * Given a 16-bit input, generate the output value of a function
 * using a 256-word lookup table with interpolation between entries.
 *
 * Table must have all deltas: -32768 <= delta <= 32767
 */
static br_int_16 interp(br_int_16 input, const br_uint_16 *table)
{
    uint8_t index        = (input & 0xFF00) >> 8;
    int16_t base_value   = (br_int_16)table[index];
    int16_t next_value   = (br_int_16)table[index + 1];
    int     delta        = next_value - base_value;
    int     scaled_delta = (delta * (input & 0xFF)) >> 8;

    return (br_int_16)(base_value + scaled_delta);
}

br_fixed_ls BR_PUBLIC_ENTRY BrFixedSin(br_fixed_luf a)
{
    return interp((int16_t)a, sin_table) * 2;
}

br_fixed_ls BR_PUBLIC_ENTRY BrFixedCos(br_fixed_luf a)
{
    return interp((int16_t)a, cos_table) * 2;
}

br_fixed_luf BR_PUBLIC_ENTRY BrFixedASin(br_fixed_ls s)
{
    br_int_16 offset_input = (br_int_16)((s + BR_ONE_LS) >> 1);
    return interp(offset_input, arcsin_table);
}

br_fixed_luf BR_PUBLIC_ENTRY BrFixedATan2(br_fixed_ls x, br_fixed_ls y)
{
    float v = BrScalarToFloat(BR_ATAN2(BrFixedToScalar(x), BrFixedToScalar(y)));
    if(v < 0.0f)
        v += 1.0f;
    return BrFloatToFixedLUF(v);
}

br_fixed_ls BR_PUBLIC_ENTRY BrFixedSqrt(br_fixed_ls a)
{
    return BrFloatToFixed(BrFloatSqrt(BrFixedToFloat(a)));
}

br_fixed_ls BR_PUBLIC_ENTRY BrFixedPow(br_fixed_ls a, br_fixed_ls b)
{
    return BrFloatToFixed(BrFloatPow(BrFixedToFloat(a), BrFixedToFloat(b)));
}

// clang-format off
const static br_uint_16 sin_table[257] = {
    0x00000, 0x00324, 0x00647, 0x0096A, 0x00C8B, 0x00FAB, 0x012C7, 0x015E1,
    0x018F8, 0x01C0B, 0x01F19, 0x02223, 0x02527, 0x02826, 0x02B1E, 0x02E10,
    0x030FB, 0x033DE, 0x036B9, 0x0398C, 0x03C56, 0x03F16, 0x041CD, 0x0447A,
    0x0471C, 0x049B3, 0x04C3F, 0x04EBF, 0x05133, 0x0539A, 0x055F4, 0x05842,
    0x05A81, 0x05CB3, 0x05ED6, 0x060EB, 0x062F1, 0x064E7, 0x066CE, 0x068A5,
    0x06A6C, 0x06C23, 0x06DC9, 0x06F5E, 0x070E1, 0x07254, 0x073B5, 0x07503,
    0x07640, 0x0776B, 0x07883, 0x07989, 0x07A7C, 0x07B5C, 0x07C29, 0x07CE2,
    0x07D89, 0x07E1C, 0x07E9C, 0x07F08, 0x07F61, 0x07FA6, 0x07FD7, 0x07FF5,
    0x07FFF, 0x07FF5, 0x07FD7, 0x07FA6, 0x07F61, 0x07F08, 0x07E9C, 0x07E1C,
    0x07D89, 0x07CE2, 0x07C29, 0x07B5C, 0x07A7C, 0x07989, 0x07883, 0x0776B,
    0x07640, 0x07503, 0x073B5, 0x07254, 0x070E1, 0x06F5E, 0x06DC9, 0x06C23,
    0x06A6C, 0x068A5, 0x066CE, 0x064E7, 0x062F1, 0x060EB, 0x05ED6, 0x05CB3,
    0x05A81, 0x05842, 0x055F4, 0x0539A, 0x05133, 0x04EBF, 0x04C3F, 0x049B3,
    0x0471C, 0x0447A, 0x041CD, 0x03F16, 0x03C56, 0x0398C, 0x036B9, 0x033DE,
    0x030FB, 0x02E10, 0x02B1E, 0x02826, 0x02527, 0x02223, 0x01F19, 0x01C0B,
    0x018F8, 0x015E1, 0x012C7, 0x00FAB, 0x00C8B, 0x0096A, 0x00647, 0x00324,
    0x00000, 0x0FCDC, 0x0F9B9, 0x0F696, 0x0F375, 0x0F055, 0x0ED39, 0x0EA1F,
    0x0E708, 0x0E3F5, 0x0E0E7, 0x0DDDD, 0x0DAD9, 0x0D7DA, 0x0D4E2, 0x0D1F0,
    0x0CF05, 0x0CC22, 0x0C947, 0x0C674, 0x0C3AA, 0x0C0EA, 0x0BE33, 0x0BB86,
    0x0B8E4, 0x0B64D, 0x0B3C1, 0x0B141, 0x0AECD, 0x0AC66, 0x0AA0C, 0x0A7BE,
    0x0A57F, 0x0A34D, 0x0A12A, 0x09F15, 0x09D0F, 0x09B19, 0x09932, 0x0975B,
    0x09594, 0x093DD, 0x09237, 0x090A2, 0x08F1F, 0x08DAC, 0x08C4B, 0x08AFD,
    0x089C0, 0x08895, 0x0877D, 0x08677, 0x08584, 0x084A4, 0x083D7, 0x0831E,
    0x08277, 0x081E4, 0x08164, 0x080F8, 0x0809F, 0x0805A, 0x08029, 0x0800B,
    0x08001, 0x0800B, 0x08029, 0x0805A, 0x0809F, 0x080F8, 0x08164, 0x081E4,
    0x08277, 0x0831E, 0x083D7, 0x084A4, 0x08584, 0x08677, 0x0877D, 0x08895,
    0x089C0, 0x08AFD, 0x08C4B, 0x08DAC, 0x08F1F, 0x090A2, 0x09237, 0x093DD,
    0x09594, 0x0975B, 0x09932, 0x09B19, 0x09D0F, 0x09F15, 0x0A12A, 0x0A34D,
    0x0A57F, 0x0A7BE, 0x0AA0C, 0x0AC66, 0x0AECD, 0x0B141, 0x0B3C1, 0x0B64D,
    0x0B8E4, 0x0BB86, 0x0BE33, 0x0C0EA, 0x0C3AA, 0x0C674, 0x0C947, 0x0CC22,
    0x0CF05, 0x0D1F0, 0x0D4E2, 0x0D7DA, 0x0DAD9, 0x0DDDD, 0x0E0E7, 0x0E3F5,
    0x0E708, 0x0EA1F, 0x0ED39, 0x0F055, 0x0F375, 0x0F696, 0x0F9B9, 0x0FCDC,
    0x00000,
};

const static br_uint_16 cos_table[257] = {
    0x07FFF, 0x07FF5, 0x07FD7, 0x07FA6, 0x07F61, 0x07F08, 0x07E9C, 0x07E1C,
    0x07D89, 0x07CE2, 0x07C29, 0x07B5C, 0x07A7C, 0x07989, 0x07883, 0x0776B,
    0x07640, 0x07503, 0x073B5, 0x07254, 0x070E1, 0x06F5E, 0x06DC9, 0x06C23,
    0x06A6C, 0x068A5, 0x066CE, 0x064E7, 0x062F1, 0x060EB, 0x05ED6, 0x05CB3,
    0x05A81, 0x05842, 0x055F4, 0x0539A, 0x05133, 0x04EBF, 0x04C3F, 0x049B3,
    0x0471C, 0x0447A, 0x041CD, 0x03F16, 0x03C56, 0x0398C, 0x036B9, 0x033DE,
    0x030FB, 0x02E10, 0x02B1E, 0x02826, 0x02527, 0x02223, 0x01F19, 0x01C0B,
    0x018F8, 0x015E1, 0x012C7, 0x00FAB, 0x00C8B, 0x0096A, 0x00647, 0x00324,
    0x00000, 0x0FCDC, 0x0F9B9, 0x0F696, 0x0F375, 0x0F055, 0x0ED39, 0x0EA1F,
    0x0E708, 0x0E3F5, 0x0E0E7, 0x0DDDD, 0x0DAD9, 0x0D7DA, 0x0D4E2, 0x0D1F0,
    0x0CF05, 0x0CC22, 0x0C947, 0x0C674, 0x0C3AA, 0x0C0EA, 0x0BE33, 0x0BB86,
    0x0B8E4, 0x0B64D, 0x0B3C1, 0x0B141, 0x0AECD, 0x0AC66, 0x0AA0C, 0x0A7BE,
    0x0A57F, 0x0A34D, 0x0A12A, 0x09F15, 0x09D0F, 0x09B19, 0x09932, 0x0975B,
    0x09594, 0x093DD, 0x09237, 0x090A2, 0x08F1F, 0x08DAC, 0x08C4B, 0x08AFD,
    0x089C0, 0x08895, 0x0877D, 0x08677, 0x08584, 0x084A4, 0x083D7, 0x0831E,
    0x08277, 0x081E4, 0x08164, 0x080F8, 0x0809F, 0x0805A, 0x08029, 0x0800B,
    0x08001, 0x0800B, 0x08029, 0x0805A, 0x0809F, 0x080F8, 0x08164, 0x081E4,
    0x08277, 0x0831E, 0x083D7, 0x084A4, 0x08584, 0x08677, 0x0877D, 0x08895,
    0x089C0, 0x08AFD, 0x08C4B, 0x08DAC, 0x08F1F, 0x090A2, 0x09237, 0x093DD,
    0x09594, 0x0975B, 0x09932, 0x09B19, 0x09D0F, 0x09F15, 0x0A12A, 0x0A34D,
    0x0A57F, 0x0A7BE, 0x0AA0C, 0x0AC66, 0x0AECD, 0x0B141, 0x0B3C1, 0x0B64D,
    0x0B8E4, 0x0BB86, 0x0BE33, 0x0C0EA, 0x0C3AA, 0x0C674, 0x0C947, 0x0CC22,
    0x0CF05, 0x0D1F0, 0x0D4E2, 0x0D7DA, 0x0DAD9, 0x0DDDD, 0x0E0E7, 0x0E3F5,
    0x0E708, 0x0EA1F, 0x0ED39, 0x0F055, 0x0F375, 0x0F696, 0x0F9B9, 0x0FCDC,
    0x00000, 0x00324, 0x00647, 0x0096A, 0x00C8B, 0x00FAB, 0x012C7, 0x015E1,
    0x018F8, 0x01C0B, 0x01F19, 0x02223, 0x02527, 0x02826, 0x02B1E, 0x02E10,
    0x030FB, 0x033DE, 0x036B9, 0x0398C, 0x03C56, 0x03F16, 0x041CD, 0x0447A,
    0x0471C, 0x049B3, 0x04C3F, 0x04EBF, 0x05133, 0x0539A, 0x055F4, 0x05842,
    0x05A81, 0x05CB3, 0x05ED6, 0x060EB, 0x062F1, 0x064E7, 0x066CE, 0x068A5,
    0x06A6C, 0x06C23, 0x06DC9, 0x06F5E, 0x070E1, 0x07254, 0x073B5, 0x07503,
    0x07640, 0x0776B, 0x07883, 0x07989, 0x07A7C, 0x07B5C, 0x07C29, 0x07CE2,
    0x07D89, 0x07E1C, 0x07E9C, 0x07F08, 0x07F61, 0x07FA6, 0x07FD7, 0x07FF5,
    0x07FFF,
};

const static br_uint_16 arcsin_table[] = {
    0x0C001, 0x0C519, 0x0C737, 0x0C8D7, 0x0CA37, 0x0CB6D, 0x0CC87, 0x0CD8A,
    0x0CE7C, 0x0CF5F, 0x0D037, 0x0D104, 0x0D1C9, 0x0D286, 0x0D33C, 0x0D3ED,
    0x0D498, 0x0D53E, 0x0D5DF, 0x0D67C, 0x0D716, 0x0D7AC, 0x0D83F, 0x0D8CF,
    0x0D95C, 0x0D9E7, 0x0DA6F, 0x0DAF4, 0x0DB78, 0x0DBF9, 0x0DC79, 0x0DCF7,
    0x0DD73, 0x0DDED, 0x0DE66, 0x0DEDD, 0x0DF53, 0x0DFC8, 0x0E03B, 0x0E0AD,
    0x0E11E, 0x0E18D, 0x0E1FC, 0x0E26A, 0x0E2D6, 0x0E342, 0x0E3AC, 0x0E416,
    0x0E47F, 0x0E4E7, 0x0E54E, 0x0E5B4, 0x0E61A, 0x0E67F, 0x0E6E3, 0x0E746,
    0x0E7A9, 0x0E80C, 0x0E86D, 0x0E8CE, 0x0E92F, 0x0E98F, 0x0E9EE, 0x0EA4D,
    0x0EAAB, 0x0EB09, 0x0EB66, 0x0EBC3, 0x0EC20, 0x0EC7C, 0x0ECD7, 0x0ED33,
    0x0ED8D, 0x0EDE8, 0x0EE42, 0x0EE9C, 0x0EEF5, 0x0EF4E, 0x0EFA7, 0x0EFFF,
    0x0F057, 0x0F0AF, 0x0F106, 0x0F15D, 0x0F1B4, 0x0F20B, 0x0F261, 0x0F2B8,
    0x0F30D, 0x0F363, 0x0F3B9, 0x0F40E, 0x0F463, 0x0F4B8, 0x0F50C, 0x0F561,
    0x0F5B5, 0x0F609, 0x0F65D, 0x0F6B1, 0x0F704, 0x0F758, 0x0F7AB, 0x0F7FE,
    0x0F851, 0x0F8A4, 0x0F8F7, 0x0F949, 0x0F99C, 0x0F9EE, 0x0FA41, 0x0FA93,
    0x0FAE5, 0x0FB37, 0x0FB89, 0x0FBDB, 0x0FC2D, 0x0FC7F, 0x0FCD1, 0x0FD23,
    0x0FD74, 0x0FDC6, 0x0FE17, 0x0FE69, 0x0FEBA, 0x0FF0C, 0x0FF5E, 0x0FFAF,
    0x00000, 0x00051, 0x000A2, 0x000F4, 0x00146, 0x00197, 0x001E9, 0x0023A,
    0x0028C, 0x002DD, 0x0032F, 0x00381, 0x003D3, 0x00425, 0x00477, 0x004C9,
    0x0051B, 0x0056D, 0x005BF, 0x00612, 0x00664, 0x006B7, 0x00709, 0x0075C,
    0x007AF, 0x00802, 0x00855, 0x008A8, 0x008FC, 0x0094F, 0x009A3, 0x009F7,
    0x00A4B, 0x00A9F, 0x00AF4, 0x00B48, 0x00B9D, 0x00BF2, 0x00C47, 0x00C9D,
    0x00CF3, 0x00D48, 0x00D9F, 0x00DF5, 0x00E4C, 0x00EA3, 0x00EFA, 0x00F51,
    0x00FA9, 0x01001, 0x01059, 0x010B2, 0x0110B, 0x01164, 0x011BE, 0x01218,
    0x01273, 0x012CD, 0x01329, 0x01384, 0x013E0, 0x0143D, 0x0149A, 0x014F7,
    0x01555, 0x015B3, 0x01612, 0x01671, 0x016D1, 0x01732, 0x01793, 0x017F4,
    0x01857, 0x018BA, 0x0191D, 0x01981, 0x019E6, 0x01A4C, 0x01AB2, 0x01B19,
    0x01B81, 0x01BEA, 0x01C54, 0x01CBE, 0x01D2A, 0x01D96, 0x01E04, 0x01E73,
    0x01EE2, 0x01F53, 0x01FC5, 0x02038, 0x020AD, 0x02123, 0x0219A, 0x02213,
    0x0228D, 0x02309, 0x02387, 0x02407, 0x02488, 0x0250C, 0x02591, 0x02619,
    0x026A4, 0x02731, 0x027C1, 0x02854, 0x028EA, 0x02984, 0x02A21, 0x02AC2,
    0x02B68, 0x02C13, 0x02CC4, 0x02D7A, 0x02E37, 0x02EFC, 0x02FC9, 0x030A1,
    0x03184, 0x03276, 0x03379, 0x03493, 0x035C9, 0x03729, 0x038C9, 0x03AE7,
    0x04000,
};
// clang-format on
